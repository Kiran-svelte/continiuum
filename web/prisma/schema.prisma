generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UnitType {
  company
  division
  department
  team
  sub_team
}

enum Gender {
  M
  F
  O
}

enum LeaveStatus {
  draft
  pending
  approved
  rejected
  cancelled
  escalated
}

enum PaymentStatus {
  pending
  processed
  paid
  failed
}

enum DocType {
  passport
  contract
  id_proof
  tax_form
  offer_letter
  experience_letter
  payslip
  pan_card
  aadhaar
  bank_details
  other
}

enum AIRecommendation {
  approve
  reject
  review
  escalate
}

enum UserRole {
  employee
  team_lead
  manager
  director
  hr
  admin
}

enum OnboardingStatus {
  not_started
  in_progress
  pending_approval
  approved
  completed
}

enum ApprovalStatus {
  pending
  approved
  rejected
}

enum EmployeeStatus {
  onboarding
  probation
  active
  on_notice
  suspended
  terminated
  resigned
  exited
}

enum RegularizationStatus {
  pending
  approved
  rejected
}

enum PayrollRunStatus {
  draft
  generated
  under_review
  approved
  processed
  paid
  rejected
}

enum MovementType {
  promotion
  transfer
  role_change
  department_change
  designation_change
}

enum ShiftType {
  morning
  afternoon
  night
  general
  flexible
  rotational
}

enum NotificationChannel {
  in_app
  email
  sms
  whatsapp
}

enum ReimbursementStatus {
  submitted
  under_review
  approved
  rejected
  paid
}

enum DocVerificationStatus {
  pending
  verified
  rejected
  expired
}

// ============================================================================
// 1. ORGANIZATION STRUCTURE
// ============================================================================

model OrganizationUnit {
  unit_id        Int               @id @default(autoincrement())
  unit_code      String            @unique
  unit_name      String
  unit_type      UnitType
  parent_unit_id Int?
  head_emp_id    String?
  company_id     String?
  country_code   String            @default("IN")
  location       String?
  cost_center    String?
  is_active      Boolean           @default(true)
  deleted_at     DateTime?
  created_at     DateTime          @default(now())

  parent    OrganizationUnit?  @relation("OrgHierarchy", fields: [parent_unit_id], references: [unit_id])
  children  OrganizationUnit[] @relation("OrgHierarchy")
  employees Employee[]

  @@index([company_id])
  @@index([unit_type])
  @@map("organization_units")
}

// ============================================================================
// 2. JOB LEVELS
// ============================================================================

model JobLevel {
  level_id             Int       @id @default(autoincrement())
  level_code           String    @unique
  level_name           String
  level_rank           Int
  company_id           String?
  can_approve_leave    Boolean   @default(false)
  max_reportees        Int       @default(0)
  min_experience_years Int       @default(0)
  is_management        Boolean   @default(false)
  is_executive         Boolean   @default(false)

  employees Employee[]

  @@index([company_id])
  @@map("job_levels")
}

// ============================================================================
// 3. EMPLOYEES
// ============================================================================

model Employee {
  emp_id          String    @id @unique
  full_name       String
  email           String    @unique
  phone           String?
  department      String?
  designation     String?
  position        String?
  manager_id      String?
  hire_date       DateTime?
  employment_type String?   // full_time, part_time, contract, intern
  work_location   String?
  level_code      String?   @default("L3")
  country_code    String?   @default("IN")
  gender          Gender?
  is_active       Boolean   @default(true)

  // Role system (multi-role support)
  role            UserRole  @default(employee)      // Primary role (kept for backward compat)
  primary_role    UserRole  @default(employee)      // Primary role determines dashboard
  secondary_roles Json?                              // String[] of additional roles

  // Employee lifecycle status
  status              EmployeeStatus @default(onboarding)
  employee_code       String?        // Company-specific ID (e.g., EMP-001)

  // Organization unit link
  org_unit_id         Int?
  org_unit            OrganizationUnit? @relation(fields: [org_unit_id], references: [unit_id])

  // Job level link
  job_level_id        Int?
  job_level           JobLevel? @relation(fields: [job_level_id], references: [level_id])

  // Probation
  probation_end_date  DateTime?
  probation_confirmed Boolean  @default(false)

  // Resignation / exit
  notice_period_days  Int?      @default(30)
  resignation_date    DateTime?
  last_working_date   DateTime?
  exit_date           DateTime?

  // Auth & Integrations
  clerk_id             String? @unique
  google_id            String?
  google_access_token  String?
  google_refresh_token String?
  slack_user_id        String?

  // Self-referencing manager relation
  manager            Employee?          @relation("Manager", fields: [manager_id], references: [emp_id])
  reports            Employee[]         @relation("Manager")

  // Core feature relations
  leave_requests     LeaveRequest[]
  leave_balances     LeaveBalance[]
  approval_hierarchy ApprovalHierarchy?
  attendances        Attendance[]
  documents          Document[]
  payrolls           Payroll[]

  // Organization/Company Link
  org_id  String?
  company Company? @relation(fields: [org_id], references: [id])

  // Onboarding
  terms_accepted_at      DateTime?
  onboarding_status      OnboardingStatus @default(not_started)
  onboarding_step        String?
  onboarding_data        Json?
  approval_status        ApprovalStatus   @default(pending)
  approved_by            String?
  approved_at            DateTime?
  rejection_reason       String?
  onboarding_completed   Boolean          @default(false)
  tutorial_completed     Boolean          @default(false)
  welcome_shown          Boolean          @default(false)

  // Legacy Compensation (backward compat - new system uses SalaryStructure)
  base_salary       Decimal? @db.Decimal(10, 2)
  pf_rate           Decimal? @db.Decimal(4, 3) @default(0.12)
  insurance_amount  Decimal? @db.Decimal(10, 2)
  professional_tax  Decimal? @db.Decimal(10, 2)
  other_allowances  Decimal? @db.Decimal(10, 2)
  other_deductions  Decimal? @db.Decimal(10, 2)
  gst_applicable    Boolean? @default(false)

  // Soft delete
  deleted_at DateTime?

  // Audit relations
  audits_triggered AuditLog[] @relation("Actor")

  // New feature relations
  shifts              EmployeeShift[]
  salary_structure    SalaryStructure?
  salary_revisions    SalaryRevision[]
  reimbursements      Reimbursement[]
  notifications_received Notification[] @relation("NotificationRecipient")
  status_history      EmployeeStatusHistory[]
  movements           EmployeeMovement[]
  regularizations     AttendanceRegularization[]
  exit_checklist      ExitChecklist?
  leave_encashments   LeaveEncashment[]
  payroll_slips       PayrollSlip[]

  @@index([org_id])
  @@index([status])
  @@index([primary_role])
  @@index([org_unit_id])
  @@index([clerk_id])
  @@index([manager_id])
  @@map("employees")
}

// ============================================================================
// 4. RBAC - PERMISSIONS
// ============================================================================

model Permission {
  id           String   @id @default(uuid())
  code         String   @unique  // e.g., "leave.approve_team"
  name         String            // "Approve Team Leave"
  module       String            // "leave", "attendance", "payroll", etc.
  description  String?
  is_active    Boolean  @default(true)
  created_at   DateTime @default(now())

  role_permissions RolePermission[]

  @@index([module])
  @@map("permissions")
}

model RolePermission {
  id            String     @id @default(uuid())
  company_id    String
  role          UserRole
  permission_id String
  permission    Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)
  granted       Boolean    @default(true)
  created_at    DateTime   @default(now())

  @@unique([company_id, role, permission_id])
  @@index([company_id, role])
  @@map("role_permissions")
}

// ============================================================================
// 5. APPROVAL HIERARCHY
// ============================================================================

model ApprovalHierarchy {
  hierarchy_id    Int      @id @default(autoincrement())
  emp_id          String   @unique
  level1_approver String
  level2_approver String?
  level3_approver String?
  level4_approver String?
  hr_partner      String?
  effective_from  DateTime
  effective_to    DateTime @default(dbgenerated("'2099-12-31'::date"))
  is_active       Boolean  @default(true)

  employee Employee @relation(fields: [emp_id], references: [emp_id])

  @@map("approval_hierarchy")
}

// ============================================================================
// 6. LEAVE REQUESTS
// ============================================================================

model LeaveRequest {
  request_id   String   @id
  emp_id       String
  country_code String
  leave_type   String
  start_date   DateTime
  end_date     DateTime
  total_days   Decimal  @db.Decimal(5, 2)
  working_days Decimal  @db.Decimal(5, 2)
  is_half_day  Boolean  @default(false)
  reason       String   @db.Text

  // AI Analysis
  ai_recommendation AIRecommendation?
  ai_confidence     Decimal?          @db.Decimal(5, 4)
  ai_analysis_json  Json?

  // Workflow
  status           LeaveStatus @default(pending)
  current_approver String?

  // Approval/Rejection tracking
  approved_by       String?    @db.Text
  approved_at       DateTime?
  rejection_reason  String?    @db.Text
  approver_comments String?    @db.Text
  escalation_reason String?    @db.Text

  // SLAs
  sla_deadline     DateTime?
  sla_breached     Boolean   @default(false)
  escalation_count Int       @default(0)

  // Cancellation
  cancelled_at     DateTime?
  cancel_reason    String?   @db.Text

  // Soft delete
  deleted_at DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  employee Employee @relation(fields: [emp_id], references: [emp_id])

  @@index([emp_id, status])
  @@index([status, created_at])
  @@index([current_approver])
  @@index([sla_deadline, sla_breached])
  @@map("leave_requests")
}

// ============================================================================
// 7. LEAVE BALANCES
// ============================================================================

model LeaveBalance {
  balance_id   Int    @id @default(autoincrement())
  emp_id       String
  country_code String
  leave_type   String
  year         Int

  annual_entitlement Decimal @db.Decimal(5, 2)
  carried_forward    Decimal @default(0) @db.Decimal(5, 2)
  used_days          Decimal @default(0) @db.Decimal(5, 2)
  pending_days       Decimal @default(0) @db.Decimal(5, 2)
  encashed_days      Decimal @default(0) @db.Decimal(5, 2)

  employee Employee @relation(fields: [emp_id], references: [emp_id])

  @@unique([emp_id, leave_type, year])
  @@map("leave_balances")
}

// ============================================================================
// 8. COMPANY (Multi-Tenancy)
// ============================================================================

model Company {
  id         String   @id @default(uuid())
  company_id String?  @unique @default(uuid())
  name       String
  code       String   @unique
  industry   String?
  admin_id   String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt @default(now())

  // Core relations
  employees     Employee[]
  policies      ConstraintPolicy[]
  audit_logs    AuditLog[]
  subscriptions Subscription[]
  usage_records UsageRecord[]
  api_keys      ApiKey[]
  payments      Payment[]
  leave_types   LeaveType[]
  leave_rules   LeaveRule[]
  settings      CompanySettings?

  // Metadata
  size     String?
  location String?
  website  String?
  logo_url String?

  // Subscription Tier (cached)
  subscription_tier String @default("FREE")

  // Work Schedule Settings
  work_start_time    String   @default("09:00")
  work_end_time      String   @default("18:00")
  grace_period_mins  Int      @default(15)
  half_day_hours     Decimal  @default(4) @db.Decimal(3, 1)
  full_day_hours     Decimal  @default(8) @db.Decimal(3, 1)
  work_days          Json     @default("[1,2,3,4,5]")
  timezone           String   @default("Asia/Kolkata")

  // Leave Settings
  leave_year_start   String   @default("01-01")
  carry_forward_max  Int      @default(5)
  probation_leave    Boolean  @default(false)
  negative_balance   Boolean  @default(false)

  // Probation & Notice (configurable per company, not hardcoded)
  probation_period_days Int   @default(180)
  notice_period_days    Int   @default(30)
  sla_hours             Int   @default(48)

  // Leave encashment (India-specific)
  encashment_enabled   Boolean  @default(false)
  encashment_max_days  Int      @default(30)
  encashment_per_day   Decimal? @db.Decimal(10, 2)

  // Payroll settings (India-compliant)
  pf_enabled           Boolean  @default(true)
  pf_employer_rate     Decimal  @default(12)    @db.Decimal(5, 2)
  pf_employee_rate     Decimal  @default(12)    @db.Decimal(5, 2)
  pf_ceiling           Decimal  @default(15000) @db.Decimal(10, 2)
  esi_enabled          Boolean  @default(false)
  esi_employer_rate    Decimal  @default(3.25)  @db.Decimal(5, 2)
  esi_employee_rate    Decimal  @default(0.75)  @db.Decimal(5, 2)
  esi_ceiling          Decimal  @default(21000) @db.Decimal(10, 2)
  pt_state             String?
  tds_enabled          Boolean  @default(true)

  // Onboarding Settings
  onboarding_completed Boolean @default(false)

  // Billing
  stripe_customer_id   String?
  razorpay_customer_id String?
  billing_email        String?
  billing_phone        String?
  gstin                String?

  // Legal
  legal_agreed_at DateTime?

  // Soft delete
  deleted_at DateTime?

  // New feature relations
  shifts                 Shift[]
  salary_components      SalaryComponent[]
  notification_templates NotificationTemplate[]
  payroll_runs           PayrollRun[]

  @@map("companies")
}

// ============================================================================
// 8b. LEAVE TYPES (Dynamic per company)
// ============================================================================

model LeaveType {
  id              String   @id @default(uuid())
  company_id      String
  code            String
  name            String
  description     String?
  color           String   @default("#6366f1")

  // Entitlement
  annual_quota    Decimal  @db.Decimal(5, 2) @default(0)
  max_consecutive Int      @default(5)
  min_notice_days Int      @default(1)

  // Restrictions
  requires_document Boolean @default(false)
  requires_approval Boolean @default(true)
  half_day_allowed  Boolean @default(true)
  gender_specific   Gender?

  // Carry Forward
  carry_forward     Boolean @default(false)
  max_carry_forward Int     @default(0)

  // Encashment
  encashable        Boolean @default(false)

  // Probation restriction
  available_during_probation Boolean @default(false)

  // Status
  is_active       Boolean  @default(true)
  is_paid         Boolean  @default(true)
  sort_order      Int      @default(0)
  deleted_at      DateTime?

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@unique([company_id, code])
  @@map("leave_types")
}

// ============================================================================
// 8c. LEAVE RULES (Dynamic policies per company)
// ============================================================================

model LeaveRule {
  id              String   @id @default(uuid())
  company_id      String
  name            String
  description     String?

  rule_type       String   // "blackout", "max_concurrent", "min_gap", "department_limit", "sandwich", "monthly_quota", "custom"
  config          Json

  is_blocking     Boolean  @default(true)
  priority        Int      @default(0)

  applies_to_all  Boolean  @default(true)
  departments     Json?

  is_active       Boolean  @default(true)
  effective_from  DateTime @default(now())
  effective_to    DateTime?
  deleted_at      DateTime?

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("leave_rules")
}

// ============================================================================
// 9. LEAVE ENCASHMENT (India-specific)
// ============================================================================

model LeaveEncashment {
  id             String   @id @default(uuid())
  emp_id         String
  leave_type     String
  days           Decimal  @db.Decimal(5, 2)
  per_day_amount Decimal  @db.Decimal(10, 2)
  total_amount   Decimal  @db.Decimal(12, 2)
  year           Int
  reason         String   // "year_end", "resignation", "policy"

  status         String   @default("pending") // pending | approved | paid
  approved_by    String?
  approved_at    DateTime?
  paid_in_payroll_id String?

  created_at     DateTime @default(now())

  employee Employee @relation(fields: [emp_id], references: [emp_id])

  @@index([emp_id, year])
  @@map("leave_encashments")
}

// ============================================================================
// 10. CONSTRAINT POLICIES (Legacy)
// ============================================================================

model ConstraintPolicy {
  id         String   @id @default(uuid())
  org_id     String
  name       String   @default("Default Policy")
  rules      Json
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  organization Company @relation(fields: [org_id], references: [id])

  @@map("constraint_policies")
}

// ============================================================================
// 11. AUDIT LOGS (Enterprise-Grade)
// ============================================================================

model AuditLog {
  id               String   @id @default(uuid())

  actor_type       String   @default("user")
  actor_id         String
  actor_role       String?

  action           String
  entity_type      String
  entity_id        String
  resource_name    String?
  previous_state   Json?
  new_state        Json?
  details          Json?

  created_at       DateTime @default(now()) @db.Timestamptz(3)

  ip_address       String?
  user_agent       String?
  request_id       String?

  decision         String?
  decision_reason  String?
  confidence_score Float?
  model_version    String?
  rules_evaluated  Json?

  target_org       String

  integrity_hash   String?
  prev_hash        String?

  actor            Employee? @relation("Actor", fields: [actor_id], references: [emp_id])
  company          Company  @relation(fields: [target_org], references: [id])

  @@index([created_at])
  @@index([actor_id])
  @@index([entity_type, entity_id])
  @@index([action])
  @@index([target_org, created_at])

  @@map("audit_logs")
}

// ============================================================================
// 12. ATTENDANCE
// ============================================================================

model Attendance {
  id          String    @id @default(uuid())
  emp_id      String
  date        DateTime  @db.Date
  check_in    DateTime?
  check_out   DateTime?
  total_hours Decimal?  @db.Decimal(4, 2)
  status      String    // PRESENT, ABSENT, LATE, HALF_DAY, WFH, ON_LEAVE, HOLIDAY

  // Shift tracking
  shift_id    String?
  shift       Shift?    @relation(fields: [shift_id], references: [id])

  // Enhanced tracking
  late_minutes      Int      @default(0)
  overtime_minutes  Int      @default(0)
  is_wfh            Boolean  @default(false)

  // Location tracking (optional geo-fencing)
  check_in_location  Json?   // { lat, lng, address }
  check_out_location Json?

  employee    Employee  @relation(fields: [emp_id], references: [emp_id])

  // Regularization link
  regularization AttendanceRegularization?

  @@unique([emp_id, date])
  @@index([emp_id, status])
  @@map("attendance")
}

// ============================================================================
// 13. ATTENDANCE REGULARIZATION
// ============================================================================

model AttendanceRegularization {
  id             String   @id @default(uuid())
  emp_id         String
  employee       Employee @relation(fields: [emp_id], references: [emp_id])
  attendance_id  String   @unique
  attendance     Attendance @relation(fields: [attendance_id], references: [id])

  original_in    DateTime?
  original_out   DateTime?
  requested_in   DateTime
  requested_out  DateTime
  reason         String

  status         RegularizationStatus @default(pending)
  approved_by    String?
  approved_at    DateTime?
  rejection_reason String?

  created_at     DateTime @default(now())

  @@index([emp_id, status])
  @@map("attendance_regularizations")
}

// ============================================================================
// 14. SHIFT MANAGEMENT
// ============================================================================

model Shift {
  id             String    @id @default(uuid())
  company_id     String
  company        Company   @relation(fields: [company_id], references: [id])
  name           String
  code           String
  type           ShiftType @default(general)
  start_time     String    // "09:00"
  end_time       String    // "18:00"
  break_minutes  Int       @default(60)
  grace_minutes  Int       @default(15)
  is_overnight   Boolean   @default(false)
  is_default     Boolean   @default(false)
  is_active      Boolean   @default(true)
  deleted_at     DateTime?

  employees      EmployeeShift[]
  attendances    Attendance[]

  @@unique([company_id, code])
  @@map("shifts")
}

model EmployeeShift {
  id             String    @id @default(uuid())
  emp_id         String
  employee       Employee  @relation(fields: [emp_id], references: [emp_id])
  shift_id       String
  shift          Shift     @relation(fields: [shift_id], references: [id])
  effective_from DateTime
  effective_to   DateTime?
  is_active      Boolean   @default(true)

  @@index([emp_id, is_active])
  @@map("employee_shifts")
}

// ============================================================================
// 15. PAYROLL (Legacy - kept for backward compat)
// ============================================================================

model Payroll {
  id             String        @id @default(uuid())
  emp_id         String
  month          Int
  year           Int
  basic_salary   Decimal       @db.Decimal(10, 2)
  allowances     Decimal       @db.Decimal(10, 2)
  deductions     Decimal       @db.Decimal(10, 2)
  net_pay        Decimal       @db.Decimal(10, 2)
  status         PaymentStatus @default(pending)
  processed_date DateTime?

  employee Employee @relation(fields: [emp_id], references: [emp_id])

  @@unique([emp_id, month, year])
  @@map("payroll")
}

// ============================================================================
// 16. SALARY COMPONENTS (India-Compliant)
// ============================================================================

model SalaryComponent {
  id             String   @id @default(uuid())
  company_id     String
  company        Company  @relation(fields: [company_id], references: [id])
  name           String   // "Basic", "HRA", "DA", "Special Allowance"
  code           String   // "BASIC", "HRA", "DA", "SA"
  type           String   // "earning" | "deduction" | "employer_contribution"
  calculation    String   // "fixed" | "percentage_of_basic" | "percentage_of_gross" | "percentage_of_ctc"
  default_value  Decimal? @db.Decimal(10, 2)
  percentage     Decimal? @db.Decimal(5, 2)
  is_taxable     Boolean  @default(true)
  is_statutory   Boolean  @default(false)
  is_active      Boolean  @default(true)
  sort_order     Int      @default(0)

  @@unique([company_id, code])
  @@map("salary_components")
}

model SalaryStructure {
  id             String   @id @default(uuid())
  emp_id         String   @unique
  employee       Employee @relation(fields: [emp_id], references: [emp_id])
  ctc            Decimal  @db.Decimal(12, 2)   // Annual CTC
  basic          Decimal  @db.Decimal(10, 2)   // Monthly basic
  components     Json     // Array of { component_code, amount, percentage }
  effective_from DateTime
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  @@map("salary_structures")
}

model SalaryRevision {
  id              String   @id @default(uuid())
  emp_id          String
  employee        Employee @relation(fields: [emp_id], references: [emp_id])
  old_ctc         Decimal  @db.Decimal(12, 2)
  new_ctc         Decimal  @db.Decimal(12, 2)
  reason          String
  effective_from  DateTime
  approved_by     String?
  approved_at     DateTime?
  status          String   @default("pending") // pending | approved | rejected
  created_at      DateTime @default(now())

  @@index([emp_id])
  @@map("salary_revisions")
}

// ============================================================================
// 17. PAYROLL RUN (New - India-Compliant)
// ============================================================================

model PayrollRun {
  id               String          @id @default(uuid())
  company_id       String
  company          Company         @relation(fields: [company_id], references: [id])
  month            Int
  year             Int
  status           PayrollRunStatus @default(draft)
  generated_by     String?
  approved_by      String?
  processed_by     String?
  generated_at     DateTime?
  approved_at      DateTime?
  processed_at     DateTime?
  total_gross      Decimal         @db.Decimal(14, 2) @default(0)
  total_deductions Decimal         @db.Decimal(14, 2) @default(0)
  total_net        Decimal         @db.Decimal(14, 2) @default(0)
  total_pf         Decimal         @db.Decimal(14, 2) @default(0)
  total_esi        Decimal         @db.Decimal(14, 2) @default(0)
  total_tds        Decimal         @db.Decimal(14, 2) @default(0)
  total_pt         Decimal         @db.Decimal(14, 2) @default(0)
  employee_count   Int             @default(0)
  notes            String?

  slips            PayrollSlip[]

  @@unique([company_id, month, year])
  @@map("payroll_runs")
}

model PayrollSlip {
  id              String     @id @default(uuid())
  payroll_run_id  String
  payroll_run     PayrollRun @relation(fields: [payroll_run_id], references: [id])
  emp_id          String
  employee        Employee   @relation(fields: [emp_id], references: [emp_id])

  // Attendance summary
  working_days      Int
  present_days      Decimal   @db.Decimal(5, 2)
  absent_days       Decimal   @db.Decimal(5, 2) @default(0)
  paid_leave_days   Decimal   @db.Decimal(5, 2) @default(0)
  unpaid_leave_days Decimal   @db.Decimal(5, 2) @default(0)
  late_count        Int       @default(0)
  overtime_hours    Decimal   @db.Decimal(5, 2) @default(0)

  // Earnings breakdown
  basic             Decimal   @db.Decimal(10, 2)
  hra               Decimal   @db.Decimal(10, 2) @default(0)
  da                Decimal   @db.Decimal(10, 2) @default(0)
  special_allowance Decimal   @db.Decimal(10, 2) @default(0)
  other_earnings    Json?     // Array of { name, amount }
  gross_salary      Decimal   @db.Decimal(10, 2)

  // Deductions breakdown (India-compliant)
  pf_employee       Decimal   @db.Decimal(10, 2) @default(0)
  pf_employer       Decimal   @db.Decimal(10, 2) @default(0)
  esi_employee      Decimal   @db.Decimal(10, 2) @default(0)
  esi_employer      Decimal   @db.Decimal(10, 2) @default(0)
  professional_tax  Decimal   @db.Decimal(10, 2) @default(0)
  tds               Decimal   @db.Decimal(10, 2) @default(0)
  lop_deduction     Decimal   @db.Decimal(10, 2) @default(0)
  other_deductions  Json?     // Array of { name, amount }
  total_deductions  Decimal   @db.Decimal(10, 2)

  // Net
  net_pay           Decimal   @db.Decimal(10, 2)

  @@unique([payroll_run_id, emp_id])
  @@index([emp_id])
  @@map("payroll_slips")
}

// ============================================================================
// 18. REIMBURSEMENTS
// ============================================================================

model Reimbursement {
  id             String              @id @default(uuid())
  emp_id         String
  employee       Employee            @relation(fields: [emp_id], references: [emp_id])
  category       String              // "travel", "medical", "food", "communication", "other"
  amount         Decimal             @db.Decimal(10, 2)
  description    String
  receipt_url    String?

  status         ReimbursementStatus @default(submitted)
  approved_by    String?
  approved_at    DateTime?
  rejection_reason String?
  paid_in_payroll_id String?

  submitted_at   DateTime            @default(now())

  @@index([emp_id, status])
  @@map("reimbursements")
}

// ============================================================================
// 19. DOCUMENTS
// ============================================================================

model Document {
  id              String   @id @default(uuid())
  emp_id          String
  type            DocType
  name            String
  file_url        String
  file_size       Int?
  mime_type       String?

  // Verification workflow
  verification_status DocVerificationStatus @default(pending)
  verified_by     String?
  verified_at     DateTime?
  rejection_reason String?

  // Expiry tracking
  expiry_date     DateTime?
  renewal_reminder_sent Boolean @default(false)

  verified    Boolean  @default(false) // Legacy field
  uploaded_at DateTime @default(now())

  employee Employee @relation(fields: [emp_id], references: [emp_id])

  @@index([emp_id])
  @@index([verification_status])
  @@map("documents")
}

// ============================================================================
// 20. EMPLOYEE LIFECYCLE
// ============================================================================

model EmployeeStatusHistory {
  id             String         @id @default(uuid())
  emp_id         String
  employee       Employee       @relation(fields: [emp_id], references: [emp_id])
  from_status    EmployeeStatus
  to_status      EmployeeStatus
  reason         String?
  changed_by     String
  effective_date DateTime
  created_at     DateTime       @default(now())

  @@index([emp_id])
  @@map("employee_status_history")
}

model EmployeeMovement {
  id               String       @id @default(uuid())
  emp_id           String
  employee         Employee     @relation(fields: [emp_id], references: [emp_id])
  type             MovementType

  from_department  String?
  from_designation String?
  from_role        UserRole?
  from_org_unit_id Int?
  from_manager_id  String?

  to_department    String?
  to_designation   String?
  to_role          UserRole?
  to_org_unit_id   Int?
  to_manager_id    String?

  reason           String?
  effective_date   DateTime
  approved_by      String?
  approved_at      DateTime?
  status           String   @default("pending") // pending | approved | rejected

  created_at       DateTime @default(now())

  @@index([emp_id])
  @@map("employee_movements")
}

model ExitChecklist {
  id             String   @id @default(uuid())
  emp_id         String   @unique
  employee       Employee @relation(fields: [emp_id], references: [emp_id])

  equipment_returned     Boolean @default(false)
  id_card_returned       Boolean @default(false)
  knowledge_transfer     Boolean @default(false)
  pending_leaves_settled Boolean @default(false)
  final_settlement_done  Boolean @default(false)
  exit_interview_done    Boolean @default(false)
  access_revoked         Boolean @default(false)
  documents_collected    Boolean @default(false)

  custom_items           Json?   // Array of { name, completed }

  completed_at           DateTime?
  processed_by           String?

  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  @@map("exit_checklists")
}

// ============================================================================
// 21. NOTIFICATIONS
// ============================================================================

model Notification {
  id           String              @id @default(uuid())
  recipient_id String
  recipient    Employee            @relation("NotificationRecipient", fields: [recipient_id], references: [emp_id])

  title        String
  message      String
  type         String              // "leave_approved", "attendance_reminder", "payroll_ready", etc.
  channel      NotificationChannel @default(in_app)
  priority     String              @default("normal") // low | normal | high | urgent

  entity_type  String?             // "leave_request", "attendance", "payroll"
  entity_id    String?
  action_url   String?

  read_at      DateTime?
  sent_at      DateTime            @default(now())

  @@index([recipient_id, read_at])
  @@index([recipient_id, type])
  @@map("notifications")
}

model NotificationTemplate {
  id           String              @id @default(uuid())
  company_id   String
  company      Company             @relation(fields: [company_id], references: [id])
  event_type   String
  channel      NotificationChannel
  subject      String?
  body         String              @db.Text
  is_active    Boolean             @default(true)

  @@unique([company_id, event_type, channel])
  @@map("notification_templates")
}

model NotificationPreference {
  id           String              @id @default(uuid())
  emp_id       String
  event_type   String
  channel      NotificationChannel
  enabled      Boolean             @default(true)

  @@unique([emp_id, event_type, channel])
  @@map("notification_preferences")
}

// ============================================================================
// 22. COMPANY SETTINGS
// ============================================================================

model CompanySettings {
  id                  String   @id @default(uuid())
  company_id          String   @unique

  holiday_mode        String   @default("auto")
  country_code        String   @default("IN")
  custom_holidays     Json?
  blocked_dates       Json?

  // Email Notification Settings
  email_checkin_reminder    Boolean @default(true)
  email_checkout_reminder   Boolean @default(true)
  email_hr_missing_alerts   Boolean @default(true)
  email_leave_notifications Boolean @default(true)
  email_approval_reminders  Boolean @default(true)

  // Reminder Timing
  checkin_reminder_1_mins   Int     @default(10)
  checkin_reminder_2_mins   Int     @default(60)
  checkout_reminder_1_mins  Int     @default(60)
  checkout_reminder_2_mins  Int     @default(10)

  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  company             Company  @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@map("company_settings")
}

// ============================================================================
// 23. PUBLIC HOLIDAYS
// ============================================================================

model PublicHoliday {
  id           String   @id @default(uuid())
  date         DateTime @db.Date
  name         String
  local_name   String?
  country_code String
  year         Int
  is_global    Boolean  @default(true)
  types        Json?
  cached_at    DateTime @default(now())

  @@unique([date, country_code])
  @@map("public_holidays")
}

// ============================================================================
// 24-27. PLATFORM & MARKETING
// ============================================================================

model Waitlist {
  id             String   @id @default(uuid())
  email          String   @unique
  company_name   String?
  employee_count String?
  source         String?  @default("website")
  status         String   @default("pending")
  created_at     DateTime @default(now())
  invited_at     DateTime?
  notes          String?

  @@map("waitlist")
}

model Subscription {
  id                       String    @id @default(uuid())
  subscription_id          String    @unique @default(uuid())
  org_id                   String
  plan                     String    @default("FREE")
  plan_tier                String    @default("FREE")
  status                   String    @default("active")
  billing_cycle            String    @default("monthly")
  stripe_customer_id       String?
  stripe_subscription_id   String?
  razorpay_customer_id     String?
  razorpay_subscription_id String?
  razorpay_order_id        String?
  current_period_start     DateTime?
  current_period_end       DateTime?
  trial_end                DateTime?
  cancel_at_period_end     Boolean   @default(false)
  canceled_at              DateTime?
  created_at               DateTime  @default(now())
  updated_at               DateTime  @updatedAt

  company Company @relation(fields: [org_id], references: [id])

  @@index([org_id])
  @@map("subscriptions")
}

model UsageRecord {
  id          String   @id @default(uuid())
  org_id      String
  feature     String
  quantity    Int      @default(1)
  recorded_at DateTime @default(now())
  metadata    Json?

  company Company @relation(fields: [org_id], references: [id])

  @@index([org_id, feature, recorded_at])
  @@map("usage_records")
}

model ApiKey {
  id         String   @id @default(uuid())
  org_id     String
  name       String
  key        String   @unique
  is_active  Boolean  @default(true)
  last_used  DateTime?
  created_at DateTime @default(now())
  expires_at DateTime?

  company Company @relation(fields: [org_id], references: [id])

  @@map("api_keys")
}

model Payment {
  id                    String   @id @default(uuid())
  org_id                String
  amount                Int
  currency              String   @default("INR")
  status                String
  razorpay_payment_id   String?  @unique
  razorpay_order_id     String?
  razorpay_signature    String?
  method                String?
  bank                  String?
  wallet                String?
  vpa                   String?
  error_code            String?
  error_description     String?
  fee                   Int?
  tax                   Int?
  invoice_id            String?
  international         Boolean  @default(false)
  refund_status         String?
  amount_refunded       Int?
  captured_at           DateTime?
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  company Company @relation(fields: [org_id], references: [id])

  @@index([org_id, created_at])
  @@index([razorpay_order_id])
  @@map("payments")
}

// ============================================================================
// 28-30. SYSTEM MONITORING
// ============================================================================

model SystemIncident {
  id               String    @id @default(uuid())
  title            String
  description      String    @db.Text
  status           String    @default("investigating")
  severity         String    @default("minor")
  affected_services Json     @default("[]")

  started_at       DateTime  @default(now())
  identified_at    DateTime?
  resolved_at      DateTime?

  updates          Json      @default("[]")

  notification_sent Boolean  @default(false)
  notified_users   Json     @default("[]")

  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  @@index([status, created_at])
  @@index([started_at])
  @@map("system_incidents")
}

model UptimeRecord {
  id           String   @id @default(uuid())
  service      String
  status       String
  latency_ms   Int?
  checked_at   DateTime @default(now())
  error_message String?

  @@index([service, checked_at])
  @@map("uptime_records")
}

model PlatformStats {
  id              String   @id @default(uuid())
  stat_type       String   @unique
  stat_value      String
  display_value   String
  is_verified     Boolean  @default(false)
  last_calculated DateTime @default(now())

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@map("platform_stats")
}

model PricingPlan {
  id              String   @id @default(uuid())
  code            String   @unique
  name            String
  description     String?

  price_monthly   Decimal  @db.Decimal(10, 2)
  price_yearly    Decimal  @db.Decimal(10, 2)
  currency        String   @default("INR")

  max_employees   Int?
  max_hr_admins   Int      @default(1)

  features        Json     @default("[]")

  sla_uptime      Decimal  @db.Decimal(5, 2) @default(95.00)
  sla_support     String   @default("Community")
  sla_response    String?

  stripe_price_monthly    String?
  stripe_price_yearly     String?
  razorpay_plan_monthly   String?
  razorpay_plan_yearly    String?

  is_popular      Boolean  @default(false)
  is_active       Boolean  @default(true)
  sort_order      Int      @default(0)

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@map("pricing_plans")
}

model Testimonial {
  id              String   @id @default(uuid())
  name            String
  role            String
  company         String
  avatar_url      String?
  content         String   @db.Text
  rating          Int      @default(5)

  is_verified     Boolean  @default(false)
  verified_at     DateTime?
  source          String?
  source_url      String?

  is_featured     Boolean  @default(false)
  is_active       Boolean  @default(true)
  sort_order      Int      @default(0)

  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@map("testimonials")
}

// ============================================================================
// 31-32. SECURITY
// ============================================================================

model OtpToken {
  id            String    @id @default(uuid())
  user_id       String
  company_id    String
  email         String
  code          String
  action        String
  context       Json?
  attempts      Int       @default(0)
  max_attempts  Int       @default(3)
  expires_at    DateTime
  verified_at   DateTime?
  created_at    DateTime  @default(now())

  @@index([user_id, action])
  @@index([email, code])
  @@map("otp_tokens")
}

model SettingsAuditLog {
  id            String   @id @default(uuid())
  company_id    String
  user_id       String
  user_email    String
  action        String
  previous_value Json?
  new_value     Json?
  otp_verified  Boolean  @default(false)
  ip_address    String?
  user_agent    String?
  created_at    DateTime @default(now())

  @@index([company_id])
  @@index([user_id])
  @@map("settings_audit_logs")
}
